
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="text-center card-header">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-message" class="mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        
    </div>
    <div class="container mt-5">
        <h2 class="d-flex justify-content-between align-items-center">Instructor Dashboard  <a href="/logout" class="btn btn-sm btn-danger">Logout</a></h2>
        <h3>Welcome! {{ username }} </h3>
        <br>
        <div class="container mt-5">
            <div class="card mt-5">
                <div class="card-header">
                    <h5>Register for Courses</h5>
                </div>
                <div class="card-body">
                    <label for="semester-year" class="form-label">Semster Year</label>
                    <select class="form-select" id="semester-year" name="semester_year" required>
                        <option value="Fall 2024">Fall 2024</option>
                        <option value="Spring 2025">Spring 2025</option>
                        <option value="Summer 2025">Summer 2025</option>
                        <option value="Fall 2025">Fall 2025</option>
                    </select>
                    <div id="courses-container">
                        <!-- New fields populated here -->
                    </div>
                </div>
            </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Section ID</th>
                    <th>Course ID</th>
                    <th>Students</th>
                </tr>
            </thead>
            <tbody>
                {% for data in grouped_data %}
                <tr>
                    <td>{{ data.section_id }}</td>
                    <td>{{ data.course_id }}</td>
                    <td>
                        {% if data.students is iterable and not data.students is string %}
                        {{ data.students | join(', ') }}
                        {% else %}
                            {{ data.students }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="container mt-5">
        <h4>Course Material</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Course Title</th>
                    <th>Section</th>
                    <th>Description</th>
                    <th>Attachments</th>
                </tr>
            </thead>
            <tbody>
                {% for material in course_material %}
                <tr>
                    <td>{{ material.course_title }}</td>
                    <td>{{ material.section }}</td>
                    <td>{{ material.description }}</td>
                    <td>
                        {% for attachment in material.attachments %}
                        <a href="{{ url_for('uploaded_file', filename=attachment) }}" target="_blank">{{ attachment }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('upload_course_material') }}" class="btn btn-primary">Add New Course Material</a>
    </div>


    <div class="container mt-5">
        <h4>Assignments</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Assignment Title</th>
                    <th>Section</th>
                    <th>Description</th>
                    <th>Attachments</th>
                </tr>
            </thead>
            <tbody>
                {% for material in assignment_material %}
                <tr>
                    <td>{{ material.assignment_title }}</td>
                    <td>{{ material.section_id }}</td>
                    <td>{{ material.description }}</td>
                    <td>
                        {% for attachment in material.attachments %}
                        <a href="{{ url_for('uploaded_file', filename=attachment) }}" target="_blank">{{ attachment }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('instructor_create_assignment') }}" class="btn btn-primary">Add New Assignment</a>
    </div>

    <!-- Grade submitted assignments -->
    <div class="container mt-5">
        <h4>Submitted Assignments</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Assignment Title</th>
                    <th>Student</th>
                    <th>Attachments</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody>
                
                {% for assignment in submitted_assignments %}
                {% if assignment.status == 'submitted' %}
                <tr>
                    <td>{{ assignment.assignment_title }}</td>
                    <td>{{ assignment.student_name }}</td>
                    <td>
                        
                        <a href="{{ url_for('uploaded_file', filename=assignment.completed_file) }}" target="_blank">{{ assignment.completed_file }}</a>{% if not loop.last %}, {% endif %}
                        
                    </td>
                    <td>
                        <form action="/grade_assignment" method="POST">
                            <input type="hidden" name="assignment_id" value="{{ assignment._id }}">
                            <input type="hidden" name="student_id" value="{{ assignment.student_id }}">
                            <input type="text" name="grade" class="form-control" value="{{ assignment.grade }}">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    

<script>
    // Flash message display
    setTimeout(() => {
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            flashMessage.style.display = 'none';
        }
    }, 5000); // 5000ms = 5 seconds
    </script>
    <script>
        document.getElementById('semester-year').addEventListener('change', function () {
        const selectedSemester = this.value;
        const courseData = {{ course_data|tojson|safe }};
        const coursesContainer = document.getElementById('courses-container');

        coursesContainer.innerHTML = ''; // Clear previous data

       if (selectedSemester) {
        // Filter data for the selected semester
        const matchedData = courseData.filter(item => item.semester_year === selectedSemester);

        if (matchedData.length > 0) {
            // Create dropdown for courses
            const courseDropdown = document.createElement('select');
            courseDropdown.className = "form-select mb-3";
            courseDropdown.name = "course_id";
            courseDropdown.id = "course-dropdown";
            courseDropdown.innerHTML = '<option value="">Select Course</option>';

            // Populate course dropdown with unique course_id values
            const uniqueCourses = [...new Set(matchedData.map(item => item.course_id))];
            uniqueCourses.forEach(courseId => {
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = courseId;
                courseDropdown.appendChild(option);
            });

            // Add course dropdown to container
            coursesContainer.appendChild(courseDropdown);

            // Create container for section dropdown
            const sectionContainer = document.createElement('div');
            sectionContainer.id = 'section-container';
            coursesContainer.appendChild(sectionContainer);

            // Create submit button (initially hidden)
            const submitButton = document.createElement('button');
            submitButton.type = 'button'; // Changed to 'button' to prevent form submission before AJAX
            submitButton.className = 'btn btn-primary mt-3';
            submitButton.textContent = 'Submit';
            submitButton.style.display = 'none'; // Hide submit button initially
            coursesContainer.appendChild(submitButton);

            // Add event listener for course dropdown
            courseDropdown.addEventListener('change', function () {
                const selectedCourse = this.value;
                const sectionContainer = document.getElementById('section-container');
                sectionContainer.innerHTML = ''; // Clear previous data

                if (selectedCourse) {
                    // Filter sections based on selected course and semester
                    const matchedSections = matchedData.filter(item => item.course_id === selectedCourse);

                    if (matchedSections.length > 0) {
                        // Create section dropdown
                        const sectionDropdown = document.createElement('select');
                        sectionDropdown.className = "form-select mb-3";
                        sectionDropdown.name = "section_id";
                        sectionDropdown.innerHTML = '<option value="">Select Section</option>';

                        // Populate section dropdown with section_id values
                        matchedSections.forEach(section => {
                            const option = document.createElement('option');
                            option.value = section.section_id;
                            option.textContent = section.section_id;
                            sectionDropdown.appendChild(option);
                        });

                        // Add section dropdown to section container
                        sectionContainer.appendChild(sectionDropdown);

                        // Show the submit button once course and section are selected
                        sectionDropdown.addEventListener('change', function () {
                            // Enable submit button only when all selections are made
                            if (this.value) {
                                submitButton.style.display = 'block'; // Show submit button
                            } else {
                                submitButton.style.display = 'none'; // Hide submit button if section not selected
                            }
                        });
                    } else {
                        sectionContainer.innerHTML = '<p>No sections available for the selected course.</p>';
                    }
                }
            });

            // Handle form submission via AJAX (on submit button click)
            submitButton.addEventListener('click', function () {
                const selectedCourseId = courseDropdown.value;
                const selectedSectionId = sectionContainer.querySelector('select').value;
                const selectedCourse = matchedData.find(item => item.course_id === selectedCourseId && item.section_id === selectedSectionId);

                if (selectedCourse) {
                    const data = {
                        _id: selectedCourse._id,
                        semester_year: selectedSemester,
                        section_id: selectedSectionId,
                        course_id: selectedCourse.course_id,
                        course_uid: selectedCourse.course_uid
                    };

                    // Send data to Flask using AJAX (fetch)
                    fetch('/register_course', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data) // Convert data to JSON string
                    })
                    .then(responseData => {
                        // Handle the response from Flask (e.g., display a success message)
                        alert('Course registration successful!');
                    })
                    .catch(error => {
                        console.error('Error during registration:', error);
                        alert('Error during course registration. Please try again.');
                    });
                }
            });
        } else {
            coursesContainer.innerHTML = '<p>No courses available for the selected semester.</p>';
        }
    }
        });

    </script>
    <script>
        // Flash message display
        setTimeout(() => {
            const flashMessage = document.getElementById('flash-message');
            if (flashMessage) {
                flashMessage.style.display = 'none';
            }
        }, 5000); // 5000ms = 5 seconds
        </script>
    <script>
        function deleteRecord(recordId, collection) {
            if (confirm("Are you sure you want to delete this record?")) {
                fetch(`/delete-record/${collection}/${recordId}`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        alert("Record deleted successfully.");
                        location.reload(); // Reload the page to update the table
                    } else {
                        alert("Error deleting record.");
                    }
                });
            }
        }
    </script>        
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

</body>
</html>
